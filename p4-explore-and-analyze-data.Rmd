---
title: "Exploratory Data Analysis of Uber Pickup Data"
author: "Courtney Ferguson Lee"
date: "5/9/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r echo = FALSE, message = FALSE, warning = FALSE, packages}
library(ggplot2)
library(tidyr)
library(dplyr)
library(GGally)
library(scales)
library(memisc)
library(readr)
library(gridExtra)
library(RColorBrewer)
library(bitops)
library(RCurl)
#devtools::install_github("dkahle/ggmap")
library(ggmap)
library(maptools)
library(devtools)
#install_github("quantide/mapIT")
library(lubridate)
```



```{r echo=FALSE, Load_the_Data}

# Read csv's and load taxi lookup data
setwd('/Users/courtneyfergusonlee/p4')
uber <- read.csv('uber-raw-data-janjune-15.csv')
taxi_lookup <- read.csv('taxi-zone-lookup.csv')

# May not need this if making this reproducible
#load("uber.RData", .GlobalEnv)

# Get latitude and longitude info for location data (Long Process)
citystate = 'new york city new york'
taxi_lookup <- mutate(taxi_lookup, 
       lat = geocode(paste(Zone, citystate, sep = ', '), output = 'latlon')$lat,
       lon = geocode(paste(Zone, citystate, sep = ', '), output = 'latlon')$lon)

# Check for missing latitude or longitude data
taxi_lookup.lat_na <- subset(taxi_lookup, is.na(lat))
taxi_lookup.lon_na <- subset(taxi_lookup, is.na(lon))
taxi_lookup.lat_na
taxi_lookup.lon_na

# If there's missing data, need to rename variables and replace values as nec.
names(taxi_lookup.lat_na) <- c("LocationID", 
                           "Borough",    
                           "Zone",       
                           "latitude",
                           "longitude")
names(taxi_lookup.lon_na) <- c("LocationID", 
                           "Borough",    
                           "Zone",       
                           "latitude",
                           "longitude")

# Lookup missing values in bulk, check for warnings
taxi_lookup.lat_na <- mutate(taxi_lookup.lat_na, 
       latitude = geocode(paste(Zone, citystate, sep = ', '), 
                          output = 'latlon')$lat)
taxi_lookup.lon_na <- mutate(taxi_lookup.lon_na, 
       longitude = geocode(paste(Zone, citystate, sep = ', '), 
                          output = 'latlon')$lon)

# Replace missing values CAREFULLY (Lookup is a long process)
taxi_lookup[taxi_lookup.lat_na$LocationID, 4] <- taxi_lookup.lat_na$latitude
taxi_lookup[taxi_lookup.lon_na$LocationID, 5] <- taxi_lookup.lon_na$longitude

```



```{r echo=FALSE, Sample_the_Data}

# Grab samples to lighten system load and run tests
set.seed(420)
uber_sample <- uber[sample(1:length(uber$locationID), 100000), ]

# Create Zone, Borough, lat, lon, hour, day, month and date variables
uber_sample <- uber_sample %>%
  inner_join(taxi_lookup, 
             by = c('locationID' = 'LocationID')) %>%
  mutate(hour = hour(Pickup_date),
         day = wday(Pickup_date, label = T, abbr = F),
         month = month(Pickup_date, label = T, abbr = F),
         date = day(Pickup_date))

# Known locations needeed for map
uber_sample_known <- uber_sample %>%
  filter(Borough != 'Unknown' & Borough != 'EWR') # EWR is NJ

```



```{r echo=FALSE, Format_the_Data}

# Create Zone, Borough, lat, lon, hour, day, month and date variables
uber <- uber %>%
  inner_join(taxi_lookup, 
             by = c('locationID' = 'LocationID')) %>%
  mutate(hour = hour(Pickup_date),
         day = wday(Pickup_date, label = T, abbr = F),
         month = month(Pickup_date, label = T, abbr = F),
         date = day(Pickup_date))

# Create Zone, Borough, lat, lon, hour, day, month and date variables
uber_known <- uber %>%
  filter(Borough != 'Unknown' & Borough != 'EWR') # EWR is NJ


# Create month tables for quicker execution
uber_jan <- uber %>%
  filter(month == 'January')
uber_feb <- uber %>%
  filter(month == 'February')
uber_mar <- uber %>%
  filter(month == 'March')
uber_apr <- uber %>%
  filter(month == 'April')
uber_may <- uber %>%
  filter(month == 'May')
uber_jun <- uber %>%
  filter(month == 'June')

# Bin by quarter hour, half hour and hour, turning rides into a variable
uber.by_quarter_hour <- uber %>%
  mutate(minute = minute(Pickup_date),
         quarter_hour = floor(minute/15) * 15,
         hour_plus_quarter = hour + quarter_hour/60) %>%
  group_by(month, 
           date, 
           day, 
           hour,
           hour_plus_quarter) %>%
  summarise(rides = n()) %>%
  ungroup()

uber.by_half_hour <- uber %>%
  mutate(minute = minute(Pickup_date),
         half_hour = floor(minute/30) * 30,
         hour_plus_half = hour + half_hour/60) %>%
  group_by(month, 
           date, 
           day, 
           hour,
           hour_plus_half) %>%
  summarise(rides = n()) %>%
  ungroup()

uber.by_hour <- uber %>%
  group_by(month, 
           date, 
           day, 
           hour) %>%
  summarise(rides = n()) %>%
  ungroup()

# Bin by location for map scatter plot
uber_known.by_loc <- uber_known %>%
  group_by(Zone) %>%
  summarise(rides = n()) %>%
  inner_join(taxi_lookup) %>%
  ungroup()

# Bin by hour and location
uber_known.by_hour_borough <- uber_known %>%
  group_by(month,
           date,
           day,
           hour,
           Borough) %>%
  summarise(rides = n()) %>%
  ungroup()

```


# Univariate Plots Section

## Hourly Pickups

```{r echo=FALSE, Hourly_Pickups}
ggplot(uber,
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                color = I('Blue')) +
  scale_x_continuous(breaks = 0:23) +
  ggtitle('Frequency Polygon of Pickups per Hour') +
  xlab('Hour') +
  ylab('Number of Pickups')
```


## Daily Pickups

```{r echo=FALSE, Daily_Pickups}

ggplot(uber.by_time,
       aes(x = day,
           y = rides)) +
  geom_boxplot(aes(color = day)) +
  scale_color_brewer(type = 'qual',
                     palette = 2) +
  scale_y_continuous(labels = comma) +
  ggtitle('Boxplot of Rides per Day') +
  xlab('Day of the Week') +
  ylab('Number of Pickups') +
  ggsave('pickups_per_day_boxplot.png')
```

# Monthly Pickups

```{r echo=FALSE, Monthly Pickups}

ggplot(uber.by_hour,
       aes(x = month,
           y = rides)) +
  geom_boxplot(aes(color = month)) +
  scale_color_brewer(type = 'qual',
                     palette = 2) +
  scale_y_continuous(labels = comma) +
  ggtitle('Rides per Month') +
  ylab('Number of Pickups') +
  xlab('Month') +
  ggsave('pickups_per_month_boxplot.png')


```





```{r echo=FALSE, Hourly_Pickups}

```


# Univariate Analysis

## 

### What is the structure of your dataset?

### What is/are the main feature(s) of interest in your dataset?

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?

### Did you create any new variables from existing variables in the dataset?

### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?




Goals:
Done
- Read uber data
- Explore structure
- Get map package (ggmap)
- Grab sample so your system isn't overloaded
- Month by month graphs:
  - Bar graph
  - Freq polygon
  - Box plot
- Make a heatmap for each month
  - Rides by date by month
- Correlation for # rides by:
  - Hour
  - Date
- Heatmap by time:
  - Hour
  - Day
  - Month
- Histogram of times (binned by hour) and number of rides
  - As a line
  - Make multi-level by quartile (.25, .5, .99)
    - Group by day, then do quartile ()
- Histogram of times (binned by hour) and number of rides
  - facet_wrap by day of week
- Analyze:
  - Analyze month cycles:
    - Demand ramps up a hell of a lot throughout the month, esp around the 15th
  - Analyze outliers (April, May and June 100k+)
    Possible Explanations:
      - April was normal
      - May 16: http://www.nyc.gov/html/nypd/html/pr/pr_2015_traffic_2015_05_15.shtml
      - June 27: http://www.nyc.gov/html/nypd/html/pr/pr_2015_traffic_2015_06_26.shtml

Todo
- Fun stuff:
  - Reorganize all tables and graphs
  - Check template
  - Write-up analyses.  Important so far:
    - Festivals are yuuge
    - After the 15th, demand seems to ramp up
    - Pickups pick up over the month
    - Weekday vs weekend patterns

      

# Bivariate Plots

```{r}
## Facets
# Hourly by Day
ggplot(uber,
       aes(x = hour)) +
  geom_density(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = seq(0,24,6)) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('Hourly Pickups by Day') +
  ylab('Number of Pickups') +
  facet_wrap(~ day) +
  ggsave('hourly_pickups_by_day_density.png')


# Hourly by Borough
ggplot(uber_known,
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = Borough)) +
  scale_x_continuous(breaks = seq(0,24,6)) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('Number of Pickups by Hour and Borough') +
  ylab('Number of Pickups') +
  facet_wrap(~ Borough) +
  ggsave('hourly_pickups_by_borough.png')



```



## Patterns over Time
Look at ride patterns over intervals of time
(Use over Time by: Hour, Day, Month)
Over days (dates), make another frequency polygon

```{r}
# Create histogram of pickups, faceted by date (ncol = 7)
ggplot(uber_jan,
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('January Pickups') +
  ylab('Number of Pickups') +
  facet_wrap(~ date, ncol = 7)

# Look at individual months and dates:
# June
ggplot(subset(uber.by_date, month == 'June'),
       aes(x = date,
           y = rides)) +
  geom_col()
  geom_bar() +
  scale_color_brewer(type = 'seq') +
  scale_y_continuous(labels = comma) +
  ylab('Number of Pickups') +
  xlab('Date')

# April
ggplot(subset(uber_apr),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = seq(0,24,6)) +
  scale_color_brewer(type = 'qual', 
                     palette = 2) +
  ggtitle('April Pickups') +
  ylab('Number of Pickups') +
  facet_wrap(~ date,
             ncol = 7)

# May
ggplot(subset(uber_may),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = seq(0,24,6)) +
  scale_color_brewer(type = 'qual', 
                     palette = 2) +
  ggtitle('April Pickups') +
  ylab('Number of Pickups') +
  facet_wrap(~ date,
             ncol = 7)

# April 25
ggplot(subset(uber, 
              month == 'April'  
              & date == 25),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('April 25th Pickups') +
  ylab('Number of Pickups')

# May 16
ggplot(subset(uber,
              Month == 'May',
              date == 16),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('January 13th Pickups') +
  ylab('Number of Pickups')

# June 27 (Missing Data! Where'd midnight - 7am go?)
ggplot(subset(uber_jun, date == 27),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('June 27th Pickups') +
  ylab('Number of Pickups')

# - Tues, Jan 27 (Lowest Number of Rides)
ggplot(subset(uber_jan, date == 27),
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'qual', palette = 2) +
  ggtitle('January 27th Pickups') +
  ylab('Number of Pickups')
ggsave('jan_27_pickups.png')



# Testing corellation by hour and date
with(uber.by_hour, cor.test(hour, rides))
with(uber.by_date, cor.test(date, rides))


```

# Multivariate Plots Section

## Map Scatter Plot

```{r echo=FALSE Map_Scatter_Plot}
# Map Scatterplot of New York Pickups
# Create bounding box
lon_left <- min(taxi_lookup$lon)
lon_right <- max(taxi_lookup$lon)
lat_bottom <- min(taxi_lookup$lat)
lat_top <- max(taxi_lookup$lat)

nyc <- get_map(location = c(lon_left, 
                            lat_bottom,
                            lon_right,
                            lat_top), 
               source = 'stamen')

nycMap <- ggmap(nyc,
                    extent = "panel")

nycMap +
  geom_point(aes(x = lon,
                 y = lat,
                 size = rides,
                 color = rides,
                 alpha = .01),
             #alpha = .01,
             data = uber_known.by_loc) +
  scale_color_gradient2(low = 'yellow',
                       high = 'red',
                       mid = 'yellow',
                       labels = comma,
                       guide = guide_colorbar(barheight = 20,
                                              title = 'Pickups')) +
  ggtitle('Uber Pickups Scatterplot Map') +
  scale_size(guide = 'none') +
  guides(alpha = F) +
  ggsave('scatterplot_map.png')

```

# Heatmap by month and date


```{r}
# 1st? Gametime decision.  This feels complete
ggplot(aes(y = date, 
           x = month),
       data = uber.by_date) +
  geom_tile(aes(fill = rides)) +
  scale_fill_gradientn(colors = colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100),
                       guide = guide_colorbar(barheight = 20,
                                              title = 'Pickups')) +
  ylab('Date') +
  xlab('Month') +
  ggtitle('Rides per Date Heatmap') +
  ggsave('rides_per_day_heatmap_bu_yl_rd.png')

# Same but in blue to white to red
ggplot(aes(y = date, 
           x = month),
       data = uber.by_date) +
  geom_tile(aes(fill = rides)) +
  scale_fill_gradientn(colours = colorRampPalette(c('blue', 
                                   'white', 
                                   'red'))(100),
                       guide = guide_colorbar(barheight = 20,
                                              title = 'Pickups')) +
  ggtitle('Rides per Date Heatmap') +
  xlab('Month') +
  ylab('Date') +
ggsave('rides_per_date_heatmap.png')

```

# Histogram of rides by date faceted by Month colored by Day

```{r}
# Pickups by date faceted by month
ggplot(uber,
       aes(x = date)) +
  geom_histogram(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = seq(7, 28, 7)) +
  scale_y_continuous(labels = comma) +
  scale_fill_brewer(type = 'seq', palette = 1) +
  ggtitle('Monthly Pickups by Date') +
  xlab('Date') +
  ylab('Number of Pickups') +
  facet_wrap(~ month) +
  ggsave('monthly_pickups_histogram.png')
```

# Number of rides by hour, colored by borough, faceted by day

```{r}

ggplot(uber_known.by_hour_borough,
       aes(x = hour,
           y = rides)) +
  geom_point(aes(color = Borough),
             alpha = .5) +
  ggtitle('Pickups by Hour, Borough and Day') +
  xlab('Hour') +
  ylab('Pickups') +
  scale_fill_brewer(type = 'div') +
  facet_wrap(~ day) +
  ggsave('pickups_by_hour_borough_day_scatter.png')
```

# Rides per hour by Day Scatterplots

```{r}
# Number of rides per hour scatterplot, color by day, with smooth mean line
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(aes(color = day),
             position = position_jitter(),
             alpha = .8) +
  geom_smooth() +
  ggtitle('Number of Pickups by Hour and Day') +
  ylab('Number of Pickups') +
  xlab('Time') +
  labs(color = 'Day') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'seq',
                     palette = 18)

# Number of rides per hour scatterplot with a line for every day (Sun - Sat)
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(alpha = .2,
             position = position_jitter()) +
  geom_line(aes(color = day),
            stat = 'summary', 
            fun.y = quantile,
            fun.args  =list(probs = .5)) +
  ggtitle('Number of Pickups by Hour and Day') +
  ylab('Number of Pickups') +
  xlab('Time') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'seq',
                     palette = 18)


```



-------------- Useless -------------------

# May and June Close-up (may not use)

```{r}
# May Histogram
ggplot(uber_may,
       aes(x = date)) +
  geom_histogram(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = 1:31) +
  scale_fill_brewer(type = 'seq', palette = 1) +
  ggtitle('May Pickups') +
  ylab('Number of Pickups') +
ggsave('may_pickups_histogram.png')

# June Histogram
ggplot(uber_june,
       aes(x = date)) +
  geom_histogram(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = 1:31) +
  scale_fill_brewer(type = 'seq', palette = 1) +
  ggtitle('June Pickups') +
  ylab('Number of Pickups') +
ggsave('june_pickups_histogram.png')
```



# Create a 3-graph smoothing progression:

```{r}



# By quarter-hour
p1 <- ggplot(uber.by_quarter_hour,
       aes(x = hour_plus_quarter,
           y = rides)) +
  geom_line(color = I('green')) +
  geom_smooth()

# By half hour
p2 <- ggplot(uber.by_half_hour,
       aes(x = hour_plus_half,
           y = rides)) +
  geom_line(alpha = .2)

# By hour
p3 <- ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_line(alpha = .2)

grid.arrange(p1, p2, p3, ncol = 1)

# Make a histogram! of Manhattan Zone pickups
ggplot(data = subset(uber_jan,
                     Borough == 'Manhattan'),
       aes(x = Zone)) +
  geom_histogram()
```

```{r}
# Scatterplot of pickups per hour in one color plus 3 quartiles
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(alpha = .2,
             position = position_jitter()) +
  geom_line(stat = 'summary', fun.y = quantile,
            fun.args  =list(probs = .25), 
            color = 'green') +
  geom_line(stat = 'summary', fun.y = quantile,
            fun.args  =list(probs = .5), 
            color = 'blue') +
  geom_line(stat = 'summary', fun.y = quantile,
            fun.args  =list(probs = .95), 
            color = 'purple') +
  #scale_y_log10() +
  ggtitle('Number of Pickups by Hour and Date') +
  ylab('Number of Pickups') +
  xlab('Time') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'div')
```


# Density Map with stat_density2d

```{r}
nyc <- get_map("jackson heights, new york", zoom = 11)

nycMap <- ggmap(nyc,
                    extent = "device", 
                    legend = "none")

nycMap +
  stat_density2d(aes(x = lon, 
                     y = lat, 
                     fill = ..level..),
                 alpha = .2,
                 size = .5, 
                 bins = 50, 
                 data = subset(uber_sample, 
                               Borough != 'Unknown'),
                 geom = "polygon",
                 show.legend = F) +
  scale_fill_gradient2(#"Pickups",
                       #limits = c(0, 200),
                       low = "white", 
                       mid = "yellow", 
                       high = "red",
                       guide = 'none') +
  geom_point(aes(x = lon,
                 y = lat,
                 alpha = .05,
                 color = Borough),
             data = subset(uber_sample, 
                               Borough != 'Unknown'))

```

# Using binned location data

```{r}

nyc <- get_map("jackson heights, new york", zoom = 11)
nycMap <- ggmap(nyc,
                    extent = "device")

nycMap +
  geom_point(data = uber_known.by_loc,
             aes(x = lon,
                 y = lat,
                 color = n,
                 size = n/100,
                 alpha = .1)) +
  coord_trans

```



# Experiments Sections:
- Consider turning map scatterplot into map hexplot

```{r}
nycMap +
  coord_cartesian() +
  stat_binhex(data = subset(uber_sample,
                        Borough != 'Unknown'),
                 aes(x = lon,
                     y = lat,
                     alpha = .05))
?stat_density2d
```


```{r}
# NYC Map Scatter plot with density plot (no longer used)
nycMap +
  stat_density2d(aes(x = lon, 
                     y = lat, 
                     fill = ..level..),
                 alpha = .2,
                 bins = 10, 
                 data = subset(uber_sample, 
                               Borough != 'Unknown'),
                 geom = "polygon",
                 show.legend = F) +
  scale_fill_gradient2(#"Pickups",
                       low = "white", 
                       mid = "yellow", 
                       high = "red",
                       limits = c(0, 360),
                       breaks = seq(0, 350, 50)) +
  geom_point(aes(x = lon,
                 y = lat,
                 size = n,
                 color = n,
                 alpha = .01),
             #alpha = .01,
             data = subset(uber_sample_known.by_loc, 
                               Borough != 'Unknown')) +
  scale_color_gradient2(low = 'yellow',
                       high = 'red',
                       mid = 'yellow',
                       guide = guide_colorbar(barheight = 20,
                                              title = 'Pickups')) +
  scale_size(guide = 'none') +
  guides(alpha = F)

```


# Sources of data:

1. Uber: https://github.com/fivethirtyeight/uber-tlc-foil-response
2. ggmap: D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. 
The R Journal, 5(1), 144-161. URL
  http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf

```{r}
save(taxi_lookup, 
     uber, 
     file = file.path('/Users/courtneyfergusonlee/p4/uber.RData'))
```

