---
title: "Exploratory Data Analysis of Uber Pickups"
author: "By Courtney Ferguson Lee"
date: "May 9, 2017"
output: html_document
---

<style type="text/css">
body{ /* Normal  */
      font-size: 18px;
  }
td {  /* Table  */
  font-size: 18px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```



```{r echo = FALSE, message = FALSE, warning = FALSE, packages}
library(ggplot2)
library(tidyr)
library(dplyr)
library(GGally)
library(scales)
library(memisc)
library(readr)
library(gridExtra)
library(RColorBrewer)
library(bitops)
library(RCurl)
#devtools::install_github("dkahle/ggmap")
library(ggmap)
#library(maptools)
#library(devtools)
#install_github("quantide/mapIT")
library(lubridate)
library(viridis)
```



```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}
# Read csv's and load taxi lookup data
setwd('/Users/courtneyfergusonlee/p4')
uber <- read.csv('data/uber-raw-data-janjune-15.csv')
taxi_lookup <- read.csv('data/taxi-zone-lookup.csv', stringsAsFactors = F)

# Load from RData file until ready to knit
load('data/uber.RData', .GlobalEnv)

# Edit Zones for more accurate location results
taxi_lookup[17, 3] <- 'Bedford-Stuyvesant'
taxi_lookup[23, 3] <- 'Bloomfield'
taxi_lookup[81, 3] <- 'Eastchester, Bronx'

# Get latitude and longitude info for location data (Long Process)
citystate = 'new york city new york'
taxi_lookup <- mutate(taxi_lookup, 
       lat = geocode(paste(Zone, citystate, sep = ', '), output = 'latlon')$lat,
       lon = geocode(paste(Zone, citystate, sep = ', '), output = 'latlon')$lon)

# Check for missing latitude or longitude data
taxi_lookup.lat_na <- subset(taxi_lookup, is.na(lat))
taxi_lookup.lon_na <- subset(taxi_lookup, is.na(lon))

# If there's missing data, need to rename variables and replace values as nec.
names(taxi_lookup.lat_na) <- c("LocationID", 
                           "Borough",    
                           "Zone",       
                           "latitude",
                           "longitude")
names(taxi_lookup.lon_na) <- c("LocationID", 
                           "Borough",    
                           "Zone",       
                           "latitude",
                           "longitude")

# Lookup missing values in bulk, check for warnings
taxi_lookup.lat_na <- mutate(taxi_lookup.lat_na, 
       latitude = geocode(paste(Zone, citystate, sep = ', '), 
                          output = 'latlon')$lat)
taxi_lookup.lon_na <- mutate(taxi_lookup.lon_na, 
       longitude = geocode(paste(Zone, citystate, sep = ', '), 
                          output = 'latlon')$lon)

# Replace missing values CAREFULLY (Lookup is a long process)
taxi_lookup[taxi_lookup.lat_na$LocationID, 4] <- taxi_lookup.lat_na$latitude
taxi_lookup[taxi_lookup.lon_na$LocationID, 5] <- taxi_lookup.lon_na$longitude

```



```{r echo=FALSE, message=FALSE, warning=FALSE, Sample_the_Data}

# Grab samples to lighten system load and run tests
set.seed(420)
uber_sample <- uber[sample(1:length(uber$locationID), 100000), ]

# Create Zone, Borough, lat, lon, hour, day, month and date variables
uber_sample <- uber_sample %>%
  inner_join(taxi_lookup, 
             by = c('locationID' = 'LocationID')) %>%
  mutate(Pickup_date = ymd_hms(Pickup_date),
         hour = hour(Pickup_date),
         day = wday(Pickup_date, label = T, abbr = F),
         month = month(Pickup_date, label = T, abbr = F),
         date = day(Pickup_date),
         Borough = as.factor(Borough),
         Zone = as.factor(Zone),
         locationID = as.factor(locationID)) %>%
  droplevels()



# Known locations needeed for map
uber_sample_known <- uber_sample %>%
  filter(Borough != 'Unknown' & Borough != 'EWR') # EWR is NJ

```



```{r echo=FALSE, message=FALSE, warning=FALSE, Format_the_Data}

# Create Zone, Borough, lat, lon, hour, day, month and date variables
uber <- uber %>%
  inner_join(taxi_lookup, 
             by = c('locationID' = 'LocationID')) %>%
  mutate(Pickup_date = ymd_hms(Pickup_date),
         hour = hour(Pickup_date),
         day = wday(Pickup_date, label = T, abbr = F),
         month = month(Pickup_date, label = T, abbr = F),
         date = day(Pickup_date),
         Borough = as.factor(Borough),
         Zone = as.factor(Zone),
         locationID = as.factor(locationID)) %>%
  droplevels()

# Filter known boroughs for location analyses
uber_known <- uber %>%
  filter(Borough != 'Unknown' & Borough != 'EWR') %>% # EWR is NJ
  droplevels()

# Create month tables for quicker execution
uber_jan <- uber %>%
  filter(month == 'January')
uber_feb <- uber %>%
  filter(month == 'February')
uber_mar <- uber %>%
  filter(month == 'March')
uber_apr <- uber %>%
  filter(month == 'April')
uber_may <- uber %>%
  filter(month == 'May')
uber_jun <- uber %>%
  filter(month == 'June')

# Create Saturday tables to make comparisons
saturday_rides <- uber%>%
  filter(day == 'Saturday') %>%
  group_by(month, date, day, hour) %>%
  summarise(rides = n()) %>%
  ungroup()

saturday_ave <- saturday_rides %>%
  group_by(day, hour) %>%
  summarise(ave_rides = mean(rides))

# Create individual date tables for comparisons
may_16.by_hour <- uber_may %>%
  filter(date == 16) %>%
  group_by(month, date, day, hour) %>%
  summarise(rides = n()) %>%
  ungroup() %>%
  inner_join(saturday_ave)

may_23.by_hour <- uber_may %>%
  filter(date == 23) %>%
  group_by(month, date, day, hour) %>%
  summarise(rides = n()) %>%
  ungroup() %>%
  inner_join(saturday_ave)

june_27.by_hour <- uber_jun %>%
  filter(date == 27) %>%
  group_by(month, date, day, hour) %>%
  summarise(rides = n()) %>%
  ungroup() %>%
  inner_join(saturday_ave)

# Bin by quarter hour, half hour, hour and day, turning rides into a variable
uber.by_quarter_hour <- uber %>%
  mutate(minute = minute(Pickup_date),
         quarter_hour = floor(minute/15) * 15,
         hour_plus_quarter = hour + quarter_hour/60) %>%
  group_by(month, 
           date, 
           day, 
           hour,
           hour_plus_quarter) %>%
  summarise(rides = n()) %>%
  ungroup()

uber.by_half_hour <- uber %>%
  mutate(minute = minute(Pickup_date),
         half_hour = floor(minute/30) * 30,
         hour_plus_half = hour + half_hour/60) %>%
  group_by(month, 
           date, 
           day, 
           hour,
           hour_plus_half) %>%
  summarise(rides = n()) %>%
  ungroup()

uber.by_hour <- uber %>%
  group_by(month, 
           date, 
           day, 
           hour) %>%
  summarise(rides = n()) %>%
  ungroup()

uber.by_day <- uber %>%
  group_by(month, 
           date, 
           day) %>%
  summarise(rides = n()) %>%
  ungroup()

# Bin by location for map scatter plot and location boxplot
uber_known.by_loc <- uber_known %>%
  group_by(Zone) %>%
  summarise(rides = n()) %>%
  inner_join(taxi_lookup) %>%
  ungroup()

# Bin by hour and location
uber_known.by_hour_borough <- uber_known %>%
  group_by(month,
           date,
           day,
           hour,
           Borough) %>%
  summarise(rides = n()) %>%
  ungroup()
```

# Introduction

I chose to investigate an Uber dataset of New York City pickups from January
through June of 2015. The Taxi & Limousine Commission (TLC) released the data
after receiving a Freedom of Information Law (FOIL) request from FiveThirtyEight 
on June 22, 2015. I pulled the data from the FiveThirtyEight github repo found
[here](https://github.com/fivethirtyeight/uber-tlc-foil-response).  Each 
observation represents a single pickup with the following columns:

Variable | Definition
------------------- | --------------------------------------------------
Dispatching_base_num | The TLC base company code that dispatched the Uber
Pickup_date | The full date of the pickup in yyyy-mm-dd h:m:s format
Affiliated_base_num | The TLC base company code of the Uber pickup
locationID | The pickup location ID of the Uber pickup
Borough | The New York City Borough where the pickup took place
Zone | The neighborhood in the New York City Borough where the pickup took place
lat | The latitude of the pickup Zone
lon | The longitude of the pickup Zone
month | The month that the pickup took place
date | The date (1-31) that the pickup took place
day | The day (Sunday-Saturday) that the pickup took place
hour | The hour that the pickup took place

I was most interested in how ridership varied over time and location.  I 
wanted to know how it changed by hour, week, day and month.  I also wanted to
know what the most popular Boroughs and Zones were.

# Univariate Plots Section

## Dimensions

```{r}
dim(uber)
```


## Structure

```{r}
str(uber_sample)
```

## Summary

```{r}
summary(uber_sample)

```


## Pickups by Hour

```{r echo=FALSE, message=FALSE, warning=FALSE, Hourly_Pickups}
ggplot(uber,
       aes(x = hour)) +
  geom_freqpoly(binwidth = 1,
                color = I('Blue')) +
  scale_x_continuous(limits = c(0, 23),
                     breaks = 0:23) +
  ggtitle('Pickups per Hour') +
  xlab('Time') +
  ylab('Number of Pickups') +
  ggsave('graphs/hourly_pickups_freqpoly.png')
```

```{r}
table(uber$hour)
```

The graph above shows the total number of pickups per hour.  There are 3 notable
spikes at midnight (0), 8am and 7pm.  There is also a small bump around noon for
lunch.

## Pickups by Day

```{r Day_Barchart}
ggplot(uber,
       aes(x = day)) +
  geom_bar(aes(fill = day)) +
  scale_fill_brewer(type = 'seq',
                     palette = 2) +
  ggtitle('Pickups per Day') +
  ylab('Number of Pickups') +
  xlab('Day') +
  guides(fill = 'none') +
  ggsave('graphs/day_barchart.png')
```

```{r}
# Table of pickups by day
table(uber$day)
```


Pickups per day followed an expected trend, with demand rising Monday - 
Friday, then peaking on the weekend.

## Pickups by Month

```{r echo=FALSE, message=FALSE, warning=FALSE, Monthly_Pickups}
ggplot(uber,
       aes(x = month)) +
  geom_bar(aes(fill = month)) +
  scale_fill_brewer(type = 'seq',
                     palette = 1,
                    direction = 1) +
  scale_y_continuous(labels = comma) +
  ggtitle('Pickups per Month') +
  guides(fill = 'none') +
  ylab('Number of Pickups') +
  xlab('Month') +
  ggsave('graphs/pickups_per_month_barplot.png')
```

```{r}
table(uber$month)
```


Demand over this 6-month span went from a little under 2 million rides in
January to nearly 3 million in June.

## Pickups by Borough

```{r Pickups_by_Borough}
ggplot(uber_known,
       aes(x = Borough)) +
  geom_bar(aes(fill = Borough)) +
  coord_flip() +
  scale_fill_brewer(type = 'qual',
                    palette = 4) +
  scale_y_continuous(trans = 'log',
                     labels = comma,
                     breaks = c(10,
                                100,
                                1000,
                                10000,
                                100000,
                                1000000,
                                10000000)) +
  ggtitle('Pickups by Borough') +
  ylab('Number of Pickups \n (Log Scale)') +
  guides(fill = 'none')
```

```{r}
table(uber_known$Borough)
```

```{r}
table(uber$Borough)
```



# Univariate Analysis

The Uber dataset consists of 14 million observations of pickup data spread
across 12 variables. Originally there were only 4 variables (dispatch base 
number, pickup date, affiliated base number, and location ID), but I joined that
with taxi lookup data to get Zone and Borough names for each location ID.  I 
also wanted to map each location to a set of coordinates so I used Google's API 
to get the latitude and longitude for each zone.  The Google API limits users to
2500 queries during each 24 hour period so I had to be strategic when joining 
the lookup data to the ridership data.

I parsed the month, date, day, and hour from each pickup timestamp using 
lubridate to get a more granular analysis of patterns over time.  I also binned
the pickup data by location and time for some of the histograms and boxplots. I
had a dilema when it came to the taxi lookup dataset because some of the 
location data points were missing.  It was a small subset (about 6000 
observations) but I did not want to throw away the data.  Instead I kept all 
observations for the time period analyses and excluded them from the location 
analyses.

Since the dataset was so large, I ran most tests on a sample of 100,000 
randomly selected observations before making the final plots on the population.
This saved a lot of time since some plots took a couple minutes (each) to run.

The most unusual distributions came from the location data.  Some boroughs 
only had a few hundred pickups while others were in the 10's of thousands and 
even hundreds of thousands.  This was unusual because as I saw later, these 
patterns did not change over the course of the week.  Manhattan was the busiest 
location during the week and on the weekends.  

Even more unusual was the fact that Manhattan (pop 1.6 million) is not the 
most populated Borough in New York.  Brooklyn (2.6 million) and Queens (2.3 
million) have considerably larger populations.  By contrast, the population 
density of Manhattan is twice that of Brooklyn and triple that of Queens.  This 
could be worth investigating for Uber as they expand into more markets.  It 
would be interesting to look at ridership data for other densely populated 
cities to look for correlations.

I used the lubridate, dplyr and tidyr packages to reshape the data.  I parsed 
the Pickup_date variable with lubridate to create the month, date, day and hour
columns.  Then I grouped and summarised observations to bin the rides by time 
period and location.  One day I hope to shake Hadley Wickham's hand for what he
has done for the data science community.  He is truly a prolific developer and I
feel a certain level of comfort when I see his name in a package's
documentation.

# Bivariate Plots

## Hourly Pickups

```{r echo=FALSE, message=FALSE, warning=FALSE, Hourly_by_Day}
ggplot(uber,
       aes(x = hour)) +
  geom_histogram(binwidth = 1,
                aes(color = day)) +
  scale_x_continuous(breaks = seq(0,18,6)) +
  scale_color_brewer(type = 'qual', palette = 1) +
  ggtitle('Hourly Pickups by Day') +
  guides(color = F) +
  xlab('Time') +
  ylab('Number of Pickups') +
  facet_wrap(~ day) +
  ggsave('graphs/hourly_pickups_by_day_histogram.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

This shows the distribution of pickups throughout the week.  It's easier to 
see some of the more nuanced patterns that emerge between the days.  For 
instance, the 8am peak is only prevalent Monday - Friday, most likely due to 
morning rush hour traffic.  The evening climax shifts slightly from 6 pm to 7 pm
throughout the week and its duration lengthens as passengers edge closer to the
weekend.  Instead of retiring promptly after work, demand extends through 
midnight as the night life heats up.  

This shift in rider behavior doesn't begin abruptly on Friday or even Thursday
night as I would expect, but begins as early as Tuesday as workers loosen their
ties in the evening.  Interestingly, the 8am peak remains unchanged throughout 
the week at a steady 100,000.  People are not rushing to work, but they are 
rushing to the bar in larger numbers as the week presses on.

Saturday and Sunday behavior removes the 8am peak for obvious reasons and 
instead, demand grows steadily from 6am until midnight.  The growth on Saturday
extends through this entire time period while Sunday demand tapers off around 
6pm as riders prepare for the coming work week.

## Daily Pickups

```{r echo=FALSE, message=FALSE, warning=FALSE, Daily_Pickups_Boxplot}
ggplot(uber.by_day,
       aes(x = day,
           y = rides)) +
  geom_boxplot(aes(color = day)) +
  scale_color_brewer(type = 'qual',
                     palette = 2) +
  scale_y_continuous(labels = comma,
                     breaks = seq(0, 150000, 25000)) +
  ggtitle('Pickups per Day') +
  guides(color = 'none') +
  xlab('Day') +
  ylab('Number of Pickups') +
  ggsave('graphs/pickups_per_day_boxplot.png')
```



## Monthly Pickups Colored by Day

```{r echo=FALSE, message=FALSE, warning=FALSE, Monthly_Pickups_Colored_by_Day}
# Number of pickups over time colored by day
ggplot(uber,
       aes(x = date)) +
  geom_histogram(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = seq(7, 28, 7)) +
  scale_y_continuous(labels = comma) +
  scale_fill_brewer(type = 'seq', palette = 1) +
  ggtitle('Monthly Pickups Colored by Day') +
  labs(fill = 'Day') +
  xlab('Date') +
  ylab('Number of Pickups') +
  facet_wrap(~ month) +
  ggsave('graphs/monthly_pickups_histogram.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

This graph gave me some of the most interesting information about overall 
rider behavior.  It shows both long-term increases in demand as well as more 
cyclical patterns during the week.  Demand started small in January with most 
days averaging around 40,000 - 70,000 pickups.  February saw an uptick in the 
number of 70,000+ days and June consistently reached over 100,000 rides each 
weekend. It is unclear what exactly caused the increase in demand, but it would
be interesting to examine year-over-year Uber data to see how rider behavior
changes from winter to spring.

Weekly patterns were very interesting.  Each week saw the same (relative) 
pattern.  Monday was usually the least popular day, with demand rising steadily
before climaxing on Saturday. Interestingly, Sunday was a more popular day than
Monday, which could have been partly due to the extra runoff when Saturday
night turned into Sunday early morning.

Understanding this weekly cycle piqued my interest in weeks that did not 
follow the pattern.  The week of May 17-24 was particularly interesting because
the climax was on a Thursday and demand actually dropped on Friday and Saturday.
I tried looking up historical data from the area during that time period but was 
unable to find anything to explain the strange shift in rider behavior.

This also helped identify outliers.  Of particular note were Saturday, May 16
and Saturday, June 27.  Both days saw demand surge past 100,000 riders.  It
seemed worth investigating to understand why ridership increased so much and
possibly how to replicate those results.  The section below dives into May and 
June in more depth.


## May and June In-Depth

```{r echo=FALSE, message=FALSE, warning=FALSE, May_June}
# Create histogram of pickups, faceted by date
# May
ggplot(uber_may,
       aes(x = hour)) +
  geom_freqpoly(aes(color = day),
                binwidth = 1) +
  scale_x_continuous(limits = c(0, 23),
                     breaks = seq(0, 18, 6)) +
  scale_color_brewer(type = 'qual', 
                     palette = 2) +
  ggtitle('May Pickups') +
  labs(color = 'Day') +
  xlab('Time') +
  ylab('Number of Pickups') +
  facet_wrap(~ date, ncol = 7) +
  ggsave('graphs/may_pickups.png', 
         width = 12, 
         height = 8, 
         units = 'in')


# June
ggplot(uber_jun,
       aes(x = hour)) +
  geom_freqpoly(aes(color = day),
                binwidth = 1) +
  scale_x_continuous(limits =c(0, 23),
                     breaks = seq(0, 18, 6)) +
  scale_color_brewer(type = 'qual', 
                     palette = 2) +
  ggtitle('June Pickups') +
  labs(color = 'Day') +
  xlab('Time') +
  ylab('Number of Pickups') +
  facet_wrap(~ date, ncol = 7) +
  ggsave('graphs/june_pickups.png', 
         width = 12, 
         height = 8, 
         units = 'in')


```

I wanted to understand how demand changed thorughout May and June. In
particular, I was interested in whether higher demand days had peaks that were 
fundamentally different or whether they resulted from the same demand curves.
May 16th started the same as any other Saturday, but instead of demand 
plateauing around 7pm, it continued to rise through 11 pm. This spike in demand
was most likely due to the festivals taking place in the area that weekend.  I 
was able to find a 
[notice](http://www.nyc.gov/html/nypd/html/pr/pr_2015_traffic_2015_05_15.shtml) 
from the NYC Police Department announcing street closures that weekend due to 
a number of local festivals and a marathon taking place.  

The same patterns emerged on June 27th.  It started the same as any other
Saturday but demand spiked in the afternoon, toping 10,000 rides for a single
hour at 11pm.  I was able to find another 
[notice](http://www.nyc.gov/html/nypd/html/pr/pr_2015_traffic_2015_06_26.shtml)
from the NYC Police Department that seemed to explain the huge surge in 
pickups. Another mixture of local festivals and a marathon was responsible for 
the increase.  And again, demand on Sunday, Monday and Tuesday afterwards was 
relatively unchanged.  I'd be very curious to see whether demand was affected on
Saturday, July 3rd and 4th.  I feel conflicted because demand should probably
drop on those days but with July 4th being a major holiday I would expect
a good-sized surge in ridership.  Unfortunately, there was no available data for
the month of July.

Seeing these patterns led me to believe there may be at least two distinct
populations of riders.  There was the Monday-Friday croud that regularly used 
the service to get to work but there was also a second, wilder population that 
liked to party when night fell and on the weekends.  This second population was 
noticeably absent on May 22 and May 23, probably because they were spent from 
the weekend before.  Demand did not suddenly drop off on the Sunday-Thursday of 
the followng week, but it did on the following Friday and Saturday.  The 
expected peaks from 6pm - 11pm simply did not show up on May 22 or May 23.

## May and June Outliers

```{r echo=FALSE, message=FALSE, warning=FALSE, May_June_Outliers}
# Look at percent change for May 16, May 24 and June 25 vs typical Saturdays
# x-axis: hours
# y-axis: percent change from baseline
p1 <- ggplot(may_16.by_hour,
       aes(x = hour,
           y = rides / ave_rides)) +
  geom_line(aes(color = I('blue'))) +
  geom_hline(linetype = 2, alpha = .3, yintercept = 1) +
  scale_x_continuous(breaks = seq(0,24,1)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(.6,1.8),
                     breaks = seq(.6,1.8,.2)) +
  ggtitle('Saturday, May 16 Pickups') +
  ylab('Pickups (% Versus Ave Saturday)') +
  xlab('Time')

p2 <- ggplot(may_23.by_hour,
       aes(x = hour,
           y = rides / ave_rides)) +
  geom_line(aes(color = I('purple'))) +
  geom_hline(linetype = 2, alpha = .3, yintercept = 1) +
  scale_x_continuous(breaks = seq(0,24,1)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(.6,1.8),
                     breaks = seq(.6,1.8,.2)) +
  ggtitle('Saturday, May 23 Pickups') +
  ylab('Pickups (% Versus Ave Saturday)') +
  xlab('Time')

p3 <- ggplot(june_27.by_hour,
       aes(x = hour,
           y = rides / ave_rides)) +
  geom_line(aes(color = I('red'))) +
  geom_hline(linetype = 2, alpha = .3, yintercept = 1) +
  scale_x_continuous(breaks = seq(0,24,1)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(.6,1.8),
                     breaks = seq(.6,1.8,.2)) +
  ggtitle('Saturday, June 27 Pickups') +
  ylab('Pickups (% Versus Ave Saturday)') +
  xlab('Time')

grid.arrange(p1, p2, p3, ncol = 1)

g <- arrangeGrob(p1, p2, p3, ncol = 1) #generates g
 ggsave(file="graphs/may16_may23_jun27_percent_change.png", 
        g,
        width = 12, 
         height = 8, 
         units = 'in')
```

I wanted to take a more in-depth look at how ridership changed on the two
biggest Saturdays in the dataset (May 16th and June 27th).  I was also
interested in how it changed on the lowest Saturday (May 23rd).  All 3 days
had above-average turnout in the early morning, but it's what happened later in
the day that had the biggest impact on the numbers.  While demand dropped below
the average on May 23rd after 10am, it was consistently above normal throughout 
the day on both May 16th and June 27.  This makes sense since demand increases
throughout the day after 10am on Saturdays in general.

## Location Boxplot

```{r echo=FALSE, message=FALSE, warning=FALSE, Location_Boxplot}
ggplot(uber_known.by_loc,
       aes(x = Borough,
           y = rides)) +
  geom_boxplot(aes(color = Borough)) +
  scale_y_log10(labels = comma,
                breaks = c(100, 1000, 10000, 100000, 500000)) +
  scale_color_brewer(type = 'qual',
                     palette = 6) +
  guides(color = 'none') +
  ggtitle('Pickups by Location') +
  ylab('Number of Pickups \n (Binned by Zone)') +
  ggsave('graphs/pickups_by_location_boxplot.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

The largest variation was in the location data.  Staten Island had very few
pickups per zone, with most falling in the low 100's.  Manhattan had the most 
pickups with some zones nearing 500,000.  I used a log scale for the y axis 
because the data was so disperse.


# Bivariate Analysis

The May and June faceted histograms helped me understand demand changes over 
time.  Although it was not a particularly eventful day, May 25th caught my 
attention because it didn't look like any other Monday in the graph.  The usual 
8am peak was curiously absent and although it was the least busy day in May and 
June, it started higher than all of the other Mondays.  It turns out that was 
Memorial day.  Again, not a particularly interesting day but still helpful for 
extrapolating information about other Monday holidays.

Ridership varied dramatically from week to week over the 6 month period but a 
few patterns remained constant.  Demand was consistently greatest on Friday and
Saturday of each week with few exceptions.  There were even a few super
Saturdays that rose above others.  I think that Uber and their drivers could
really benefit from taking a closer look at some of this data.  For instance,
the two largest peaks both happened to coincide with large festivals and
marathons.  Uber as an organization could benefit from forming city partnerships
to promote more activities as they seem to lead to surges in demand.  

Uber drivers could also benefit from some of this data.  As a former driver, I 
understand the struggle to create a feasible work schedule.  Because drivers are 
independent contractors, they set their own hours so they are entirely 
responsible for how much they can earn each day.  This can also lead to burnout,
however; because it's often difficult to predict demand without experience.


# Multivariate Plots Section

## Map Scatter Plot

```{r echo=FALSE, message=FALSE, warning=FALSE, Map_Scatter_Plot}
# Map Scatterplot of New York Pickups

lon_left <- min(taxi_lookup$lon)
lon_right <- max(taxi_lookup$lon)
lat_bottom <- min(taxi_lookup$lat)
lat_top <- max(taxi_lookup$lat)

my_breaks = c(400000,
              100000,
              50000,
              10000,
              1000,
              100)

nyc <- get_map(location = c(lon_left, 
                            lat_bottom,
                            lon_right,
                            lat_top), 
               source = 'stamen',
               maptype = 'toner')

nycMap <- ggmap(nyc,
                    extent = "panel")

nycMap +
  geom_point(aes(x = lon,
                 y = lat,
                 size = rides,
                 color = rides,
                 alpha = .5),
             #alpha = .01,
             data = uber_known.by_loc) +
  scale_color_gradientn(trans = "log10",
                        guide = 'legend',
                        guide_colorbar(title = 'Pickups'),
                        breaks = my_breaks, 
                        labels = comma, my_breaks, 
                        colors = colorRampPalette(bias = .45,
                                                  rev(brewer.pal(11, 
                                                            'RdYlGn')))(100)) +
  ggtitle('Uber Pickups Scatterplot Map') +
  scale_size(guide = 'none',
             breaks = my_breaks) +
  guides(alpha = F)
```

Most rides originated from Manhattan, with a few outliers in Brooklyn and 
Queens.  I pulled the latitude and longitude data using the Google Maps API and 
merged them with the Uber pickup data to generate the map.  I used ggmap to
create the plot and grapped the background from stamen.  I chose the black and
white (toner) version to help the data points stand out more.

## Heatmap by month and date

```{r echo=FALSE, message=FALSE, warning=FALSE, Month_Date_Heatmap}
ggplot(aes(y = date, 
           x = month),
       data = uber.by_day) +
  geom_tile(aes(fill = rides)) +
  scale_fill_gradientn(colors = 
                         colorRampPalette(rev(brewer.pal(11, 'RdYlBu')))(100),
                       guide = guide_colorbar(barheight = 20,
                                              title = 'Pickups')) +
  scale_y_continuous(breaks = seq(0,30,5)) +
  ylab('Date') +
  xlab('Month') +
  ggtitle('Pickups per Date Heatmap') +
  ggsave('graphs/pickups_per_day_heatmap.png', 
         width = 10, 
         height = 7, 
         units = 'in')

```


```{r Ride_Statistics_By_Month}
# Ride statistics by month
by(uber.by_day$rides, uber.by_day$month, summary)
```

This heatmap highlights overall changes in ridership over time. It is easy to
see the busiest (June 27th) and slowest (Jan 27th)  days during the 6-month time
period.  I used dplyr's group_by and summarise functions to bin the ride data
by date, then used geom_tile() to create the heatmap.  I played around with
scale_fill_gradientn() to get an appropriate-looking color palette.  I had to
reverse the scaling because originally the higher values were blue and the lower
ones were red.

## Pickups per hour by Day Scatterplots

```{r echo=FALSE, message=FALSE, warning=FALSE, Pickups_by_Hour_Day_Colored}
# Number of rides per hour scatterplot, color by day, with smooth mean line
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(aes(color = day),
             position = position_jitter(),
             alpha = .8) +
  geom_smooth() +
  ggtitle('Pickups by Hour and Day') +
  ylab('Number of Pickups') +
  xlab('Time') +
  labs(color = 'Day') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'seq',
                     palette = 18) +
  ggsave('graphs/rides_per_hour_color_by_day_scatter.png', 
         width = 12, 
         height = 8, 
         units = 'in')

# Number of rides per hour scatterplot with a line for every day (Sun - Sat)
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(alpha = .2,
             position = position_jitter()) +
  geom_line(aes(color = day),
            stat = 'summary', 
            fun.y = quantile,
            fun.args  =list(probs = .5)) +
  ggtitle('Pickups by Hour with Daily Median') +
  labs(color = 'Day') +
  ylab('Number of Pickups') +
  xlab('Time') +
  labs(color = 'Day') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'seq',
                     palette = 18) +
  ggsave('graphs/rides_per_hour_scatter_with_daily_medians.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

The above graphs show the distribution of rides per hour for all dates in the
6-month time period.  The top graph is colored by day, which highlights how 
demand rose along a gradient from Sunday (yellow) through Saturday (dark red).
I threw in a smoothing curve to show the (mean) average demand for all days. The
bottom graph helps distinguish the two types of demand curves for Monday -
Friday vs Saturday and Sunday.

## Pickups by Hour 2D Density Plot

```{r}
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_bin2d(bins = 23) +
  scale_x_continuous(breaks = 0:23) +
  scale_fill_viridis() +
  ggtitle('Pickups per Hour 2D Density Plot') +
  labs(fill = 'Count') +
  ylab('Number of Pickups') +
  xlab('Time')

```

## Weekday vs Weekend Pickups in Each Borough

```{r}
# Monday - Friday
ggplot(subset(uber_known, 
              day == 'Monday'
              | day == 'Tuesday'
              | day == 'Wednesday'
              | day == 'Thursday'
              | day == 'Friday'),
       aes(x = hour)) +
  geom_density(aes(color = Borough),
               adjust = 3) +
  scale_x_continuous(breaks = seq(0, 20, 4)) +
  scale_color_brewer(type = 'seq',
                     palette = 1) +
  theme_dark() +
  ggtitle('Monday - Friday Pickups by Borough') +
  xlab('Time') +
  ylab('Density') +
  ggsave('graphs/monday_pickups_by_borough.png', 
         width = 10, 
         height = 6, 
         units = 'in')

# Saturday
ggplot(subset(uber_known, day == 'Saturday'),
       aes(x = hour)) +
  geom_density(aes(color = Borough),
               adjust = 2) +
  scale_x_continuous(breaks = seq(0, 20, 4)) +
  scale_color_brewer(type = 'seq',
                     palette = 8) +
  theme_dark() +
  ggtitle('Saturday Pickups by Borough') +
  xlab('Time') +
  ylab('Density') +
  ggsave('graphs/monday_pickups_by_borough.png', 
         width = 10, 
         height = 6, 
         units = 'in')

# Sunday
ggplot(subset(uber_known, day =='Sunday'),
       aes(x = hour)) +
  geom_density(aes(color = Borough),
               adjust = 2) +
  scale_x_continuous(breaks = seq(0, 20, 4)) +
  scale_color_brewer(type = 'seq',
                     palette = 2) +
  theme_dark() +
  ggtitle('Sunday Pickups by Borough') +
  xlab('Time') +
  ylab('Density') +
  ggsave('graphs/monday_pickups_by_borough.png', 
         width = 10, 
         height = 6, 
         units = 'in')
```


# Multivariate Analysis

These 4 graphs complement each other well to paint a clear picture of rider
habits.  The map scatterplot highlights the most popular locations while the 
colored pickups by hour scatterplots show how rider behavior changes over time.
I think that Uber should share more of this type of data with drivers.  It takes
a lot of the guesswork out of driving and would eliminate a lot of regret over 
missed opportunities.  Having a better understanding of rider behavior would
help drivers plan a more concrete schedule.

I was surprised that February was so busy.  Even though it is the shortest 
month, more people used the service each day on average than in March or April.
It makes sense that Valentine's day was so busy, but I wonder what caused the 
uptick the following weekend (Feb 20th and 21st).  I would have expected that 
after the busy Valentine's day weekend, demand would drop the following weekend.
I tried to run a Google Trends query for the timeframe and region, but the 
results were inconclusive.


# Final Plots and Summary

### New York City Map Scatterplot

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
# Map Scatterplot of New York Pickups

lon_left <- min(taxi_lookup$lon)
lon_right <- max(taxi_lookup$lon)
lat_bottom <- min(taxi_lookup$lat)
lat_top <- max(taxi_lookup$lat)

my_breaks = c(400000,
              100000,
              50000,
              10000,
              1000,
              100)

nyc <- get_map(location = c(lon_left, 
                            lat_bottom,
                            lon_right,
                            lat_top), 
               source = 'stamen',
               maptype = 'toner')

nycMap <- ggmap(nyc,
                    extent = "panel")

nycMap +
  geom_point(aes(x = lon,
                 y = lat,
                 size = rides,
                 color = rides,
                 alpha = .5),
             #alpha = .01,
             data = uber_known.by_loc) +
  scale_color_gradientn(trans = "log10",
                        guide = 'legend',
                        guide_colorbar(title = 'Pickups'),
                        breaks = my_breaks, 
                        labels = comma, my_breaks, 
                        colors = colorRampPalette(bias = .45,
                                                  rev(brewer.pal(11, 
                                                            'RdYlGn')))(100)) +
  ggtitle('Uber Pickups Scatterplot Map') +
  scale_size(guide = 'none',
             breaks = my_breaks) +
  guides(alpha = F)
```

### Description

I chose this plot because it gives an easy to understand visualization of the
distribution of pickups by location.  We can see from the map that Manhattan
was by far the most popular region, followed by remote parts of Brooklyn and
Queens.  The dark red circle in the lower right corner is JFK Airport and the
one at the top of Queens is LaGuardia.  I coded each dot to represent the number
of pickups using both size and color because it was more helpful than either 
attribute alone.  I chose to hide the size guide because it seemed redundant.  I
also transformed the color and size to a log scale because the range of pickups 
was massive (between 2 and 460,732 pickups).  Finally, I played around with the 
bias in colorRampPalette to stretch the range of colors for larger numbers. This
helped highlight how the number of pickups seems to diminish the further you are
from the Manhattan epicenter.

### Monthly Pickups Colored by Day

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}
# Number of pickups over time colored by day
ggplot(uber,
       aes(x = date)) +
  geom_histogram(binwidth = 1,
                aes(fill = day)) +
  scale_x_continuous(breaks = seq(7, 28, 7)) +
  scale_y_continuous(labels = comma) +
  scale_fill_brewer(type = 'seq', palette = 16) +
  ggtitle('Monthly Pickups Colored by Day') +
  labs(fill = 'Day') +
  xlab('Date') +
  ylab('Number of Pickups') +
  facet_wrap(~ month) +
  ggsave('graphs/monthly_pickups_histogram.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

### Description

This plot gave me the most ideas when performing my exploratory data analysis.
It captured a lot of the subtle and not-so subtle patterns along weekly and
monthly cycles.  I colored the bars by day because it highlighted how 
demand rose throughout the week and edited the color palette so that all
bars were clearly visible.  Finally, I changed the labels from scientific 
notation to decimal notation to make them more human-readable.

### Pickups Per Hour with Daily Median Lines

```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}
# Number of rides per hour scatterplot with a line for every day (Sun - Sat)
ggplot(uber.by_hour,
       aes(x = hour,
           y = rides)) +
  geom_point(alpha = .2,
             position = position_jitter()) +
  geom_line(aes(color = day),
            stat = 'summary', 
            fun.y = quantile,
            fun.args  =list(probs = .5)) +
  ggtitle('Pickups by Hour with Daily Median') +
  labs(color = 'Day') +
  ylab('Number of Pickups') +
  xlab('Time') +
  labs(color = 'Day') +
  scale_x_continuous(breaks = 0:23) +
  scale_color_brewer(type = 'seq',
                     palette = 18) +
  ggsave('graphs/rides_per_hour_scatter_with_daily_medians.png', 
         width = 12, 
         height = 8, 
         units = 'in')
```

### Description

The Pickups by Hour with Daily Median graph was interesting because it showed 
key differences between weekdays and weekends.  There are two distinct demand 
curves at play here.  Saturday and Sunday ridership decreased from midnight to
6am, then steadily rose throughout the rest of the day.  Demand on these days
also started higher at midnight because people usually go out more on Friday and 
Saturday nights.  Monday through Friday demand decreased from midnight to 3am,
then then abruptly rose as people started waking up to get to work.  It was 
interesting to see how tight and consistent the 8am rush was, as opposed to 
the 6pm rush when some people were going home and some were heading to the bar.

------

# Reflection

This was an eye-opening project for me.  As a former Uber driver I was curious 
to see how demand changed over time and how it varied by location.  Being in the
right place at the right time can be the difference between a $2000 week and a 
$200 one.  It was fun testing my intuitions against the data even when I was 
wrong. I had no idea that a Thursday or even a Wednesday could be nearly as 
profitable as a Friday under the right conditions.  I was also surprised to 
learn that demand spiked so much around 6pm and that there really wasn't much of
a lunch rush Monday-Friday.

People need data to make more informed choices.  When LinkdIn started sharing 
even simple data (who's looked at your profile and profile tips), their 
popularity skyrocketed.  This seems like a great opportunity to empower more 
drivers.  Helping drivers perform their jobs more effectively could be a win for
all sides.  If more drivers were more aware of the cyclical patterns in their 
area they would be better equipped to maximize their time and profit.  Drivers 
would be more satisfied, leading to lower turnover and passengers would be 
better served by more experienced (and perhaps friendlier) drivers.

The biggest struggle was trying to capture as much information from each plot 
as efficiently as possible.  There were many graphs I had to throw away because
they really didn't contribute much to the report.  I also came across a few
road-blocks while using ggmaps.   For instance, I originally tried to make a 2d
histogram using stat_density2d() but was unable to because there were too many
observations.  All-in-all I was very happy to go through this and I feel like
the tools developed here can be applied to a wide variety of data exploration
projects.

# Sources

1. Uber: https://github.com/fivethirtyeight/uber-tlc-foil-response
2. ggmap: D. Kahle and H. Wickham. ggmap: Spatial Visualization with ggplot2. 
The R Journal, 5(1), 144-161. URL
  http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf

```{r echo=FALSE, message=FALSE, warning=FALSE, Save_Taxi_Data}
save(taxi_lookup, 
     file = file.path('/Users/courtneyfergusonlee/p4/uber.RData'))
```

